name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      BUILD_DIR: dist
      REMOTE_DIR: /var/www/youthjob
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || 22 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Build (Vite â†’ dist/)
        # ðŸ”‘ ViteëŠ” VITE_ ì ‘ë‘ì‚¬ í™˜ê²½ë³€ìˆ˜ë¥¼ ë¹Œë“œíƒ€ìž„ì— embed í•©ë‹ˆë‹¤.
        env:
          VITE_KAKAO_MAP_JS_KEY: ${{ secrets.VITE_KAKAO_MAP_JS_KEY }}
        run: npm run build

      # 7ìžë¦¬ SHAë¡œ ë¦´ë¦¬ì¦ˆ ì´ë¦„ ìƒì„± (Runnerì—ì„œ ê³„ì‚°)
      - name: Prepare release name
        id: prep
        run: echo "REL=release_${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Pack dist as tar.gz
        run: tar -C "${{ env.BUILD_DIR }}" -czf bundle.tgz .

      # ì›ê²©ì— ë™ì¼ ê²½ë¡œ ìƒì„± (â†’ steps.prep.outputs.REL ì‚¬ìš©)
      - name: Prepare temp dir on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e
            REL="/tmp/${{ steps.prep.outputs.REL }}"
            mkdir -p "$REL"

      # bundle ì—…ë¡œë“œ (ë™ì¼ ê²½ë¡œ)
      - name: Upload bundle
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "bundle.tgz"
          target: "/tmp/${{ steps.prep.outputs.REL }}/"

      # í•´ì œ â†’ ë£¨íŠ¸ë¡œ ë™ê¸°í™” â†’ nginx reload (ë™ì¼ ê²½ë¡œ)
      - name: Activate release
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
        # â†“â†“â†“ ì—¬ê¸°ì„œë„ steps.prep.outputs.RELì„ ë¬¸ìžì—´ë¡œ â€œì£¼ìž…â€í•´ì•¼ í•¨
          script: |
            set -e
            REL="/tmp/${{ steps.prep.outputs.REL }}"
            DEST="${{ env.REMOTE_DIR }}"

            command -v tar >/dev/null 2>&1 || (sudo apt-get update -y && sudo apt-get install -y tar)
            command -v rsync >/dev/null 2>&1 || (sudo apt-get update -y && sudo apt-get install -y rsync)

            sudo mkdir -p "$DEST"
            sudo chown -R $USER:$USER "$DEST"

            mkdir -p "$REL/unpack"
            tar -xzf "$REL/bundle.tgz" -C "$REL/unpack"
            rsync -a --delete "$REL/unpack/" "$DEST/"

            find "$DEST" -type d -exec chmod 755 {} \;
            find "$DEST" -type f -exec chmod 644 {} \;

            sudo nginx -t && sudo systemctl reload nginx
            test -f "$DEST/index.html"
            rm -rf "$REL"
